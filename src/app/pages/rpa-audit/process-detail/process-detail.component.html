<div class="process-detail-page">
  <!-- Header with Navigation -->
  <div class="page-header">
    <div class="header-navigation">
      <p-button
        icon="pi pi-arrow-left"
        severity="secondary"
        size="small"
        pTooltip="Retour à la liste"
        (onClick)="goBack()">
      </p-button>
      <div class="breadcrumb">
        <span class="breadcrumb-item">Audit RPA</span>
        <i class="pi pi-chevron-right"></i>
        <span class="breadcrumb-current" *ngIf="process">{{ process.name }}</span>
      </div>
    </div>

    <div class="header-actions" *ngIf="process">
      <div class="websocket-status" [ngClass]="{'connected': isWebSocketConnected, 'disconnected': !isWebSocketConnected}">
        <i class="pi pi-circle-fill"></i>
        <span>{{ isWebSocketConnected ? 'WebSocket Connecté' : 'WebSocket Déconnecté' }}</span>
      </div>


      <p-button
        label="Lancer Audit Complet"
        icon="pi pi-play"
        [disabled]="process.auditStatus === 'in-progress'"
        (onClick)="runAudit()">
      </p-button>
      <p-button
        label="Exporter Rapport"
        icon="pi pi-download"
        severity="info"
        (onClick)="exportReport()">
      </p-button>
    </div>
  </div>

  <!-- Process Overview -->
  <div class="process-overview" *ngIf="process">
    <div class="overview-card">
      <div class="overview-header">
        <div class="process-title">
          <h1>{{ process.name }}</h1>
          <p-tag [value]="'v' + process.version" severity="info"></p-tag>
        </div>

        <div class="status-section">
          <div class="status-badges">
            <p-tag
              [value]="process.status === 'active' ? 'Actif' : 'Inactif'"
              [severity]="getProcessStatusSeverity(process.status)">
            </p-tag>
            <p-tag
              [value]="getAuditStatusLabel(process.auditStatus)"
              [severity]="getAuditStatusSeverity(process.auditStatus)">
            </p-tag>
          </div>

          <div class="progress-summary">
            <p-badge
              [value]="process.completedRules + '/' + process.totalRules"
              severity="success">
            </p-badge>
            <span class="progress-label">règles validées</span>
          </div>
        </div>
      </div>

      <p class="process-description">{{ process.description }}</p>

      <div class="process-metadata">
        <div class="metadata-grid">
          <div class="metadata-item">
            <label><i class="pi pi-calendar"></i> Date de déploiement</label>
            <span>{{ process.deployedAt | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="metadata-item" *ngIf="process.lastAuditDate">
            <label><i class="pi pi-clock"></i> Dernier audit</label>
            <span>{{ process.lastAuditDate | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="metadata-item">
            <label><i class="pi pi-cog"></i> Statut du processus</label>
            <span>{{ process.status === 'active' ? 'Actif' : 'Inactif' }}</span>
          </div>
          <div class="metadata-item">
            <label><i class="pi pi-chart-bar"></i> Progression globale</label>
            <div class="global-progress">
              <p-progressBar
                [value]="(process.completedRules / process.totalRules) * 100"
                [showValue]="true">
              </p-progressBar>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="audit-rules-section" *ngIf="process">
    <h2 class="section-title">Règles d'Audit</h2>
      <div class="rules-grid">
      <div
        *ngFor="let rule of process.auditRules"
        class="rule-card"
        [ngClass]="'rule-status-' + rule.status">

        <div class="rule-header">
          <div class="rule-title">
            <i [class]="getRuleIcon(rule.status)" [ngClass]="getRuleStyleClass(rule.status)"></i>
            <h3>{{ rule.name }}</h3>
          </div>
        </div>

        <p class="rule-description">{{ rule.description }}</p>

        <div class="rule-metadata">
          <p-tag [value]="rule.category" severity="info"></p-tag>
          <span class="activities-count">
            {{ getValidatedActivitiesCount(rule) }}/{{ rule.activities.length }} activités validées
          </span>
        </div>

        <div class="rule-progress">
          <p-progressBar
            [value]="(getValidatedActivitiesCount(rule) / rule.activities.length) * 100"
            [showValue]="false">
          </p-progressBar>
        </div>
      </div>
    </div>

    <!-- Detailed Activities Panel -->
    <div class="activities-section">
      <h3 class="subsection-title">Stages d'Audit Séquentiels</h3>
      <div class="rules-activities-container">
        <div
          *ngFor="let rule of process.auditRules"
          class="rule-activities-panel stage-panel"
          [ngClass]="{
            'rule-completed': isRuleCompleted(rule),
            'rule-validated': rule.isValidated,
            'rule-disabled': !rule.isEnabled,
            'rule-loading': rule.isLoading
          }">

          <div class="rule-panel-header" (click)="rule.isEnabled ? toggleRuleExpansion(rule.id) : null">
            <div class="rule-title-section">
              <!-- Stage indicator -->
              <div class="stage-indicator" [ngClass]="{
                'stage-active': rule.isEnabled && !rule.isValidated,
                'stage-completed': rule.isValidated,
                'stage-disabled': !rule.isEnabled,
                'stage-loading': rule.isLoading
              }">
                <span class="stage-number" *ngIf="!rule.isLoading">{{ rule.stage }}</span>
                <i class="pi pi-spin pi-spinner" *ngIf="rule.isLoading"></i>
              </div>

              <div class="rule-info">
                <h4 [ngClass]="{
                  'completed-rule-title': isRuleCompleted(rule),
                  'disabled-rule-title': !rule.isEnabled,
                  'loading-rule-title': rule.isLoading
                }">
                  Stage {{ rule.stage }}: {{ rule.name }}
                </h4>
                <p class="rule-description" [ngClass]="{'text-gray-400': !rule.isEnabled}">
                  {{ rule.description }}
                </p>
                <p-tag [value]="rule.category"
                       [severity]="rule.isEnabled ? 'info' : 'secondary'"
                       class="rule-category-tag">
                </p-tag>
              </div>

              <!-- Loading message -->
              <div *ngIf="rule.isLoading" class="loading-message">
                <i class="pi pi-spin pi-spinner text-blue-500"></i>
                <span>Chargement en cours...</span>
              </div>

              <!-- Disabled message -->
              <div *ngIf="!rule.isEnabled && !rule.isLoading" class="disabled-message">
                <i class="pi pi-lock text-gray-400"></i>
                <span>Stage verrouillé</span>
              </div>
            </div>

            <div class="rule-status-section">
              <span class="activities-count" [ngClass]="{'text-gray-400': !rule.isEnabled}">
                {{ getValidatedActivitiesCount(rule) }}/{{ rule.activities.length }}
              </span>

              <!-- Validate button for completed rules -->
              <p-button
                *ngIf="rule.activities.length > 0 && isRuleCompleted(rule) && !rule.isValidated && rule.isEnabled"
                label="Valider Stage {{ rule.stage }}"
                icon="pi pi-check"
                severity="success"
                size="small"
                (onClick)="validateRule(rule); $event.stopPropagation()"
                pTooltip="Valider ce stage et passer au suivant">
              </p-button>

              <!-- Manual validation buttons for enabled rules with activities -->
              <div *ngIf="rule.activities.length > 0 && !rule.isValidated && rule.isEnabled"
                   class="manual-validation-buttons"
                   style="display: flex; gap: 8px; margin-left: 8px;">
                <p-button
                  label="Marquer Valide"
                  icon="pi pi-thumbs-up"
                  severity="success"
                  size="small"
                  [outlined]="true"
                  (onClick)="markRuleAsValid(rule); $event.stopPropagation()"
                  pTooltip="Marquer cette règle comme valide (force la validation)">
                </p-button>

                <p-button
                  label="Marquer Invalide"
                  icon="pi pi-thumbs-down"
                  severity="danger"
                  size="small"
                  [outlined]="true"
                  (onClick)="markRuleAsInvalid(rule); $event.stopPropagation()"
                  pTooltip="Marquer cette règle comme invalide">
                </p-button>
              </div>

              <!-- Validated indicator -->
              <p-tag
                *ngIf="rule.isValidated"
                [value]="rule.validatedBy === 'Manual-Valid' ? '✅ Valide (Manuel)' :
                         rule.validatedBy === 'Manual-Invalid' ? '❌ Invalide (Manuel)' :
                         '✅ Validé'"
                [severity]="rule.validatedBy === 'Manual-Invalid' ? 'danger' : 'success'"
                [icon]="rule.validatedBy === 'Manual-Invalid' ? 'pi pi-times' : 'pi pi-check'">
              </p-tag>

              <i class="pi pi-chevron-down expand-icon"
                 [ngClass]="{
                   'expanded': isRuleExpanded(rule.id),
                   'text-gray-400': !rule.isEnabled,
                   'cursor-pointer': rule.isEnabled,
                   'cursor-not-allowed': !rule.isEnabled
                 }"></i>
            </div>
          </div>

          <div class="rule-activities-content"
               [ngClass]="{'expanded': isRuleExpanded(rule.id), 'content-disabled': !rule.isEnabled}">

            <!-- Loading state for stage -->
            <div class="stage-loading-message" *ngIf="rule.isLoading">
              <div class="loading-indicator">
                <h4>Chargement du Stage {{ rule.stage }}...</h4>
                <p class="text-gray-600">{{ rule.description }}</p>
                <div class="loading-progress">
                  <p-progressBar mode="indeterminate"></p-progressBar>
                </div>
              </div>
            </div>

            <!-- Empty activities message for disabled stages -->
            <div class="disabled-stage-message" *ngIf="!rule.isEnabled && !rule.isLoading && rule.activities.length === 0">
              <div class="disabled-indicator">
                <i class="pi pi-lock text-gray-400" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <h4 class="text-gray-500">Stage {{ rule.stage }} - Verrouillé</h4>
                <p class="text-gray-400">Validez le stage précédent pour débloquer celui-ci</p>
                <p-tag value="En attente" severity="secondary" icon="pi pi-clock"></p-tag>
              </div>
            </div>

            <!-- Activities for active/enabled stages -->
            <div *ngIf="rule.isEnabled && !rule.isLoading && rule.activities.length > 0" class="activities-list">
              <div
                *ngFor="let activity of rule.activities; let i = index"
                class="activity-item"
                [ngClass]="{
                  'activity-validated': activity.decision,
                  'activity-new': activity.isNew
                }"
                [@slideInAnimation]="activity.isNew ? 'in' : 'static'">

                <div class="activity-content">
                  <span class="activity-number">{{ i + 1 }}.</span>
                  <span class="activity-text" [ngClass]="{'completed-activity': activity.decision}">
                    {{ activity.rule }}
                  </span>
                </div>

                <div class="activity-actions">
                  <p-button
                    label="OK"
                    size="small"
                    [severity]="activity.decision ? 'success' : 'secondary'"
                    [outlined]="!activity.decision"
                    (onClick)="setActivityDecision(rule.id, activity, true)"
                    class="ok-button">
                  </p-button>

                  <p-button
                    label="NOK"
                    size="small"
                    [severity]="!activity.decision ? 'danger' : 'secondary'"
                    [outlined]="activity.decision"
                    (onClick)="setActivityDecision(rule.id, activity, false)"
                    class="nok-button">
                  </p-button>
                </div>
              </div>
            </div>

            <!-- Empty activities message for active stage -->
            <div class="empty-activities-message"
                 *ngIf="rule.isEnabled && !rule.isLoading && rule.activities.length === 0">
              <div class="loading-indicator">
                <i class="pi pi-spin pi-spinner"></i>
                <p>En attente des résultats d'audit via WebSocket...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="!process">
    <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
    <p>Chargement des détails du processus...</p>
  </div>
</div>

<!-- Toast Messages -->
<p-toast position="top-right"></p-toast>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
